/**
 * 住所コード（全国地方公共団体コード）マッピング
 * 都道府県コード(2桁) + 市区町村コード(3桁) = 5桁
 */

// 主要な市区町村の住所コード
export const ADDRESS_CODES: { [key: string]: string } = {
  // 北海道
  '北海道札幌市中央区': '01101',
  '北海道札幌市北区': '01102',
  '北海道札幌市東区': '01103',
  '北海道札幌市白石区': '01104',
  '北海道札幌市豊平区': '01105',
  '北海道札幌市南区': '01106',
  '北海道札幌市西区': '01107',
  '北海道札幌市厚別区': '01108',
  '北海道札幌市手稲区': '01109',
  '北海道札幌市清田区': '01110',
  
  // 東京都 特別区
  '東京都千代田区': '13101',
  '東京都中央区': '13102',
  '東京都港区': '13103',
  '東京都新宿区': '13104',
  '東京都文京区': '13105',
  '東京都台東区': '13106',
  '東京都墨田区': '13107',
  '東京都江東区': '13108',
  '東京都品川区': '13109',
  '東京都目黒区': '13110',
  '東京都大田区': '13111',
  '東京都世田谷区': '13112',
  '東京都渋谷区': '13113',
  '東京都中野区': '13114',
  '東京都杉並区': '13115',
  '東京都豊島区': '13116',
  '東京都北区': '13117',
  '東京都荒川区': '13118',
  '東京都板橋区': '13119',
  '東京都練馬区': '13120',
  '東京都足立区': '13121',
  '東京都葛飾区': '13122',
  '東京都江戸川区': '13123',
  
  // 東京都 市部
  '東京都八王子市': '13201',
  '東京都立川市': '13202',
  '東京都武蔵野市': '13203',
  '東京都三鷹市': '13204',
  '東京都青梅市': '13205',
  '東京都府中市': '13206',
  '東京都昭島市': '13207',
  '東京都調布市': '13208',
  '東京都町田市': '13209',
  '東京都小金井市': '13210',
  '東京都小平市': '13211',
  '東京都日野市': '13212',
  '東京都東村山市': '13213',
  '東京都国分寺市': '13214',
  '東京都国立市': '13215',
  '東京都福生市': '13218',
  '東京都狛江市': '13219',
  '東京都東大和市': '13220',
  '東京都清瀬市': '13221',
  '東京都東久留米市': '13222',
  '東京都武蔵村山市': '13223',
  '東京都多摩市': '13224',
  '東京都稲城市': '13225',
  '東京都羽村市': '13227',
  '東京都あきる野市': '13228',
  '東京都西東京市': '13229',
  
  // 神奈川県
  '神奈川県横浜市鶴見区': '14101',
  '神奈川県横浜市神奈川区': '14102',
  '神奈川県横浜市西区': '14103',
  '神奈川県横浜市中区': '14104',
  '神奈川県横浜市南区': '14105',
  '神奈川県横浜市保土ケ谷区': '14106',
  '神奈川県横浜市磯子区': '14107',
  '神奈川県横浜市金沢区': '14108',
  '神奈川県横浜市港北区': '14109',
  '神奈川県横浜市戸塚区': '14110',
  '神奈川県横浜市港南区': '14111',
  '神奈川県横浜市旭区': '14112',
  '神奈川県横浜市緑区': '14113',
  '神奈川県横浜市瀬谷区': '14114',
  '神奈川県横浜市栄区': '14115',
  '神奈川県横浜市泉区': '14116',
  '神奈川県横浜市青葉区': '14117',
  '神奈川県横浜市都筑区': '14118',
  '神奈川県川崎市川崎区': '14131',
  '神奈川県川崎市幸区': '14132',
  '神奈川県川崎市中原区': '14133',
  '神奈川県川崎市高津区': '14134',
  '神奈川県川崎市多摩区': '14135',
  '神奈川県川崎市宮前区': '14136',
  '神奈川県川崎市麻生区': '14137',
  '神奈川県相模原市緑区': '14151',
  '神奈川県相模原市中央区': '14152',
  '神奈川県相模原市南区': '14153',
  '神奈川県横須賀市': '14201',
  '神奈川県平塚市': '14203',
  '神奈川県鎌倉市': '14204',
  '神奈川県藤沢市': '14205',
  '神奈川県小田原市': '14206',
  '神奈川県茅ヶ崎市': '14207',
  '神奈川県逗子市': '14208',
  '神奈川県三浦市': '14210',
  '神奈川県秦野市': '14211',
  '神奈川県厚木市': '14212',
  '神奈川県大和市': '14213',
  '神奈川県伊勢原市': '14214',
  '神奈川県海老名市': '14215',
  '神奈川県座間市': '14216',
  '神奈川県南足柄市': '14217',
  '神奈川県綾瀬市': '14218',
  
  // 埼玉県
  '埼玉県さいたま市西区': '11101',
  '埼玉県さいたま市北区': '11102',
  '埼玉県さいたま市大宮区': '11103',
  '埼玉県さいたま市見沼区': '11104',
  '埼玉県さいたま市中央区': '11105',
  '埼玉県さいたま市桜区': '11106',
  '埼玉県さいたま市浦和区': '11107',
  '埼玉県さいたま市南区': '11108',
  '埼玉県さいたま市緑区': '11109',
  '埼玉県さいたま市岩槻区': '11110',
  '埼玉県川越市': '11201',
  '埼玉県熊谷市': '11202',
  '埼玉県川口市': '11203',
  '埼玉県所沢市': '11208',
  '埼玉県春日部市': '11214',
  '埼玉県草加市': '11221',
  '埼玉県越谷市': '11222',
  '埼玉県戸田市': '11224',
  '埼玉県朝霞市': '11227',
  '埼玉県新座市': '11230',
  
  // 千葉県
  '千葉県千葉市中央区': '12101',
  '千葉県千葉市花見川区': '12102',
  '千葉県千葉市稲毛区': '12103',
  '千葉県千葉市若葉区': '12104',
  '千葉県千葉市緑区': '12105',
  '千葉県千葉市美浜区': '12106',
  '千葉県銚子市': '12202',
  '千葉県市川市': '12203',
  '千葉県船橋市': '12204',
  '千葉県館山市': '12205',
  '千葉県木更津市': '12206',
  '千葉県松戸市': '12207',
  '千葉県野田市': '12208',
  '千葉県茂原市': '12210',
  '千葉県成田市': '12211',
  '千葉県佐倉市': '12212',
  '千葉県柏市': '12217',
  '千葉県市原市': '12219',
  '千葉県流山市': '12220',
  '千葉県八千代市': '12221',
  '千葉県我孫子市': '12222',
  '千葉県浦安市': '12227',
  
  // 大阪府
  '大阪府大阪市都島区': '27102',
  '大阪府大阪市福島区': '27103',
  '大阪府大阪市此花区': '27104',
  '大阪府大阪市西区': '27106',
  '大阪府大阪市港区': '27107',
  '大阪府大阪市大正区': '27108',
  '大阪府大阪市天王寺区': '27109',
  '大阪府大阪市浪速区': '27111',
  '大阪府大阪市西淀川区': '27113',
  '大阪府大阪市東淀川区': '27114',
  '大阪府大阪市東成区': '27115',
  '大阪府大阪市生野区': '27116',
  '大阪府大阪市旭区': '27117',
  '大阪府大阪市城東区': '27118',
  '大阪府大阪市阿倍野区': '27119',
  '大阪府大阪市住吉区': '27120',
  '大阪府大阪市東住吉区': '27121',
  '大阪府大阪市西成区': '27122',
  '大阪府大阪市淀川区': '27123',
  '大阪府大阪市鶴見区': '27124',
  '大阪府大阪市住之江区': '27125',
  '大阪府大阪市平野区': '27126',
  '大阪府大阪市北区': '27127',
  '大阪府大阪市中央区': '27128',
  '大阪府堺市堺区': '27141',
  '大阪府堺市中区': '27142',
  '大阪府堺市東区': '27143',
  '大阪府堺市西区': '27144',
  '大阪府堺市南区': '27145',
  '大阪府堺市北区': '27146',
  '大阪府堺市美原区': '27147',
  
  // 愛知県
  '愛知県名古屋市千種区': '23101',
  '愛知県名古屋市東区': '23102',
  '愛知県名古屋市北区': '23103',
  '愛知県名古屋市西区': '23104',
  '愛知県名古屋市中村区': '23105',
  '愛知県名古屋市中区': '23106',
  '愛知県名古屋市昭和区': '23107',
  '愛知県名古屋市瑞穂区': '23108',
  '愛知県名古屋市熱田区': '23109',
  '愛知県名古屋市中川区': '23110',
  '愛知県名古屋市港区': '23111',
  '愛知県名古屋市南区': '23112',
  '愛知県名古屋市守山区': '23113',
  '愛知県名古屋市緑区': '23114',
  '愛知県名古屋市名東区': '23115',
  '愛知県名古屋市天白区': '23116',
  '愛知県豊橋市': '23201',
  '愛知県岡崎市': '23202',
  '愛知県一宮市': '23203',
  '愛知県豊川市': '23207',
  '愛知県豊田市': '23211',
  
  // 三重県
  '三重県津市': '24201',
  '三重県四日市市': '24202',
  '三重県伊勢市': '24203',
  '三重県松阪市': '24204',
  '三重県桑名市': '24205',
  '三重県鈴鹿市': '24207',
  '三重県名張市': '24208',
  '三重県尾鷲市': '24209',
  '三重県亀山市': '24210',
  '三重県鳥羽市': '24211',
  '三重県熊野市': '24212',
  '三重県いなべ市': '24214',
  '三重県志摩市': '24215',
  '三重県伊賀市': '24216',
  
  // 福岡県
  '福岡県北九州市門司区': '40101',
  '福岡県北九州市若松区': '40102',
  '福岡県北九州市戸畑区': '40103',
  '福岡県北九州市小倉北区': '40104',
  '福岡県北九州市小倉南区': '40105',
  '福岡県北九州市八幡東区': '40106',
  '福岡県北九州市八幡西区': '40107',
  '福岡県福岡市東区': '40131',
  '福岡県福岡市博多区': '40132',
  '福岡県福岡市中央区': '40133',
  '福岡県福岡市南区': '40134',
  '福岡県福岡市西区': '40135',
  '福岡県福岡市城南区': '40136',
  '福岡県福岡市早良区': '40137',
};

/**
 * 住所から丁目・番地を抽出
 * @param address 住所文字列
 * @returns { chome: 丁目, banchi: 番地 }
 */
export function extractAddressDetails(address: string): { chome: string; banchi: string } {
  if (!address) return { chome: '', banchi: '' };
  
  let chome = '';
  let banchi = '';
  
  // 丁目を抽出（例: 「七丁目」「3丁目」など）
  const chomeMatch = address.match(/([一二三四五六七八九十\d]+)丁目/);
  if (chomeMatch) {
    chome = chomeMatch[1];
    // 漢数字を数字に変換
    chome = kanjiToNumber(chome);
  }
  
  // 番地を抽出（例: 「9番1号」「341」「2-5-1」など）
  // パターン1: 「X番Y号」形式
  const banchiMatch1 = address.match(/(\d+)番(\d+)号/);
  if (banchiMatch1) {
    banchi = banchiMatch1[1] + '-' + banchiMatch1[2];
  } else {
    // パターン2: 「X番地」形式
    const banchiMatch2 = address.match(/(\d+)番地/);
    if (banchiMatch2) {
      banchi = banchiMatch2[1];
    } else {
      // パターン3: 丁目の後の数字
      const banchiMatch3 = address.match(/丁目(\d+[-\d]*)/);
      if (banchiMatch3) {
        banchi = banchiMatch3[1];
      } else {
        // パターン4: 最後の数字部分
        const banchiMatch4 = address.match(/(\d+[-\d]*)$/);
        if (banchiMatch4) {
          banchi = banchiMatch4[1];
        }
      }
    }
  }
  
  return { chome, banchi };
}

/**
 * 漢数字を数字に変換
 */
function kanjiToNumber(kanji: string): string {
  const kanjiNumbers: { [key: string]: string } = {
    '一': '1', '二': '2', '三': '3', '四': '4', '五': '5',
    '六': '6', '七': '7', '八': '8', '九': '9', '十': '10',
  };
  
  // 既に数字の場合はそのまま返す
  if (/^\d+$/.test(kanji)) return kanji;
  
  // 単純な漢数字の場合
  if (kanjiNumbers[kanji]) return kanjiNumbers[kanji];
  
  // 「十X」形式（例: 十二 = 12）
  if (kanji.startsWith('十')) {
    const rest = kanji.slice(1);
    if (rest === '') return '10';
    return '1' + (kanjiNumbers[rest] || rest);
  }
  
  // 「X十Y」形式（例: 二十三 = 23）
  const match = kanji.match(/^([一二三四五六七八九])十([一二三四五六七八九])?$/);
  if (match) {
    const tens = kanjiNumbers[match[1]] || '0';
    const ones = match[2] ? kanjiNumbers[match[2]] : '0';
    return tens + ones;
  }
  
  return kanji;
}

/**
 * 住所から住所コードを検索
 * @param address 住所文字列
 * @returns 住所コード（見つからない場合は空文字）
 */
export function getAddressCode(address: string): string {
  if (!address) return '';
  
  // 完全一致で検索
  for (const [key, code] of Object.entries(ADDRESS_CODES)) {
    if (address.startsWith(key)) {
      return code;
    }
  }
  
  // 部分一致で検索（都道府県 + 市区町村）
  // 住所から都道府県と市区町村を抽出
  const prefectureMatch = address.match(/^(北海道|東京都|大阪府|京都府|.{2,3}県)/);
  if (!prefectureMatch) return '';
  
  const prefecture = prefectureMatch[1];
  const remaining = address.slice(prefecture.length);
  
  // 市区町村を抽出（政令指定都市の区まで含む）
  const cityMatch = remaining.match(/^(.+?[市区町村])/);
  if (!cityMatch) return '';
  
  const city = cityMatch[1];
  const fullKey = prefecture + city;
  
  // 再度検索
  for (const [key, code] of Object.entries(ADDRESS_CODES)) {
    if (key === fullKey || key.startsWith(fullKey)) {
      return code;
    }
  }
  
  console.warn(`住所コードが見つかりません: ${address}`);
  return '';
}

